#!/bin/bash
# xfce4starter
#
# "Magic process" - kill, session dies
# put last in ~/.xinitrc:
# exec xfce4starter run
#
# https://wiki.archlinux.org/index.php/I3#Shutdown.2C_reboot.2C_lock_screen
# http://linuxbbq.org/bbs/viewtopic.php?f=15&t=1509
# http://stackoverflow.com/questions/696839/how-do-i-write-a-bash-script-to-restart-a-process-if-it-dies

xfce4_run() {
	until xfsettingsd & do
		echo "xfsettingsd ended unexpectedly. Respawning.." >&2
		sleep 1
	done

	until xfce4-panel & do
		echo "xfce4-panel ended unexpectedly. Respawning.." >&2
		sleep 1
	done

	until xfdesktop & do
		echo "xfdesktop ended unexpectedly. Respawning.." >&2
		sleep 1
	done

	xfwm4
}

LOCK=i3lock-wrapper
ARG="-15"	# SIGTERM for clean exit

case "$1" in
	run)
		xfce4_run
		;;
	lock)
		$LOCK
		;;
	exit)
		killall $ARG xfwm4
		;;
	suspend)
		sudo pm-suspend		# see man sudoers
		;;
	hibernate)
		sudo pm-hibernate
		;;
	reboot)
		sudo rc reboot
		;;
	shutdown)
		sudo rc shutdown
		;;
	*)
		echo "Usage: $0 {run|lock|exit|suspend|hibernate|reboot|shutdown}"
		exit 2
esac
