#!/bin/bash
# xfce4starter - GTFO License
# credits: archwiki (i3), machinebacon
#
# "Magic process" - kill, session dies
# put last in ~/.xinitrc:
# exec xfce4starter

######

xfce4_start() {
	LOCKFILE=$HOME/.xfce4.lock
	
	#[[ -f $LOCKFILE ]] && echo "XFCE4 is already started." && exit 0

	until xfsettingsd & do
		echo "xfsettingsd ended unexpectedly. Respawning.." >&2
		sleep 1
	done

	until xfce4-panel & do
		echo "xfce4-panel ended unexpectedly. Respawning.." >&2
		sleep 1
	done

	until xfdesktop & do
		echo "xfdesktop ended unexpectedly. Respawning.." >&2
		sleep 1
	done
	
	#touch "$LOCKFILE"
	xfwm4 & xfwm4_pid="$!"; wait "$xfwm4_pid"
}

#trap "{ rm -f $LOCKFILE ; exit 255 }" EXIT
#exit 0
#trap "action" SIGTERM
#trap "action" SIGKILL

## SESSION
# sudoers for no password
LOCK=i3lock-wrapper
case "$1" in
	start)
		xfce4_start
		;;
	lock)
		$LOCK
		;;
	exit)
		kill -15 "$xfwm4_pid"	# SIGTERM for orderly exit
		;;
	force)
		kill -9 "$xfwm4_pid"	# SIGKILL if shit breaks
		;;
	suspend)
		sudo pm-suspend
		;;
	hibernate)
		sudo pm-hibernate
		;;
	reboot)
		sudo rc reboot
		;;
	shutdown)
		sudo rc shutdown
		;;
	*)
		echo "Usage: $0 {start|lock|exit|force|suspend|hibernate|reboot|shutdown}"
		exit 2
esac
