#!/bin/bash
# nurse - Automatically patch Debian packages

if (( $UID == 0 )); then
	echo "Y U BUILD R00T"
	exit 1
fi

pkg=gtk+3.0
pool=$(echo $pkg | cut -c 1)
ver=3.12.2
rel=1
dist=unstable
source="http://ftp.de.debian.org/debian/pool/main/$pool/$pkg/${pkg}_$ver-$rel.dsc"
patch="https://bugs.debian.org/cgi-bin/bugreport.cgi?msg=25;filename=gtk3_disable_csd_envvar.patch;att=1;bug=744249"

depends() {
	sudo apt-get install quilt debian-archive-keyring devscripts curl
	sudo apt-get build-dep $pkg
}

prepare() {
	dget -u $source || exit 1
	pushd "$pkg-$ver"
	test -d debian/patches || mkdir -p debian/patches
	pushd debian/patches
	curl -Lo meds.patch "$patch"
	quilt import meds.patch
	popd && quilt push -a
}

build() {	
	dch --local +bbq --distribution $dist "Little GNOMEs in space."
	dpkg-buildpackage -us -uc -d
}

clean() {
	read -r -p "Remove build dependencies? [y/n]" OPTION
	case $OPTION in
		[yY])
			echo "Check and double-check before confirming."
			tac /var/log/apt/history.log | grep -m1 Install \
			| sed "s|\(([^)]*)\)||g;s|,\s||g;s|Install:||" \
			| xargs sudo apt-get purge
			;;
		[nN])
			exit
			;;
	esac
}

depends && prepare

if [[ $? -eq 0 || $? -eq 2 ]]; then
	build
	clean
else
	echo "I couldn't cure you."
	clean
fi
