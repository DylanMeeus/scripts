#!/bin/bash
# nurse - Automatically patch Debian packages

if (( $UID == 0 )); then
	echo "Y U BUILD R00T"
	exit 1
fi

pkg=gtk+3.0
pool=$(echo $pkg | cut -c 1)
ver=3.12.2
rel=1
dist=unstable
prep=('quilt debian-archive-keyring devscripts curl')
source="http://ftp.de.debian.org/debian/pool/main/$pool/$pkg/${pkg}_$ver-$rel.dsc"
patch="https://bugs.debian.org/cgi-bin/bugreport.cgi?msg=25;filename=gtk3_disable_csd_envvar.patch;att=1;bug=744249"

if ! dpkg -l $prep &>/dev/null; then
	sudo apt-get install $prep
	sudo apt-get build-dep $pkg
fi

prepare() {
	dget -u $source || exit 1
	pushd "$pkg-$ver"
	test -d debian/patches || mkdir -p debian/patches
	pushd debian/patches
	curl -Lo meds.patch "$patch"
	quilt import meds.patch
	popd && quilt push -a
	return 0
}

build() {	
	dch --local +bbq --distribution $dist "Little GNOMEs in space."
	dpkg-buildpackage -us -uc -d
}

clean() {
	tac /var/log/apt/history.log | grep -m1 Install \
	| sed "s|\(([^)]*)\)||g;s|,\s||g;s|Install:||" \
	| xargs sudo apt-get purge
}

prepare
if [[ $? -eq 0 || $? -eq 2 ]]; then
	build
else
	echo "I couldn't cure you."
fi

read -r -p "Remove build dependencies? [y/n]" OPTION
case $OPTION in
	[yY])
		clean
		;;
	[nN])
		exit
		;;
esac
