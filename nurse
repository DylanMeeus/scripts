#!/bin/bash
# nurse - Automatically patch Debian packages

if (( $UID == 0 )); then
	echo "Don't build as root, handsome"
	exit 1
fi

sudo apt-get install quilt debian-keyring devscripts curl fakeroot libdistro-info-perl

pkg=gtk+3.0
ver=3.12.2
rel=1
dist=unstable
pool=$(echo $pkg | cut -c 1)
source="http://ftp.de.debian.org/debian/pool/main/$pool/$pkg/${pkg}_$ver-$rel.dsc"
patch="https://bugs.debian.org/cgi-bin/bugreport.cgi?msg=25;filename=gtk3_disable_csd_envvar.patch;att=1;bug=744249"

depends() {	
	sudo apt-get build-dep $pkg
	deplist=("$(tac /var/log/apt/history.log | grep -m1 Install \
	| sed "s|\(([^)]*)\)||g;s|,\s||g;s|Install:||")")
}

prepare() {
	dget $source || exit 1
	pushd "$pkg-$ver"
	test -d debian/patches || mkdir -p debian/patches
	pushd debian/patches
	curl -Lo meds.patch "$patch"
	quilt import meds.patch
	popd
}

build() {	
	dch --local +bbq --distribution $dist "Just what the doctor ordered."
	dpkg-buildpackage -us -uc
}

clean() {
	read -r -p "Remove build dependencies? [y/n]" OPTION
	case $OPTION in
		[yY])
			apt-get purge "$deplist"
			;;
		[nN])
			exit
			;;
	esac
}

depends && prepare

if [[ $? -eq 0 ]]; then
	build
elif [[ $? -eq 2 ]]; then
	build
else
	echo "I couldn't cure you."
fi

rm -r "$pkg-$ver"
clean
